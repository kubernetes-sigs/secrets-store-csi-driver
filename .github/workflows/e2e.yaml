name: e2e-mock-provider
on: push
# on: 
#   workflow_dispatch:
#     inputs:
#       registry:
#         description: 'registry for image'     
#         required: true
#         default: 'gcr.io/k8s-staging-csi-secrets-store'
#       driverImageName:
#         description: 'image name'
#         required: true
#         default: 'driver'
#       driverImageVersion:
#         description: 'Image version'
#         required: true
#         default: 'v0.3.0'
jobs:
  # test:
  #   runs-on: ubuntu-20.04
  #   steps:
  #     - uses: actions/checkout@v2
  #     - name: test make
  #       run: |
  #         unset CI
  #         make e2e-mock-provider-container

  kind:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@master
      - uses: engineerd/setup-kind@v0.5.0
        with:
          version: "v0.11.1"
      - name: Setup BATS
        uses: mig4/setup-bats@af9a00deb21b5d795cabfeaa8d9060410377686d
        with:
          bats-version: 1.4.1
      - name: Testing
        run: |
          unset CI
          kind version
          kubectl cluster-info
          kubectl get pods -n kube-system
          echo "current-context:" $(kubectl config current-context)
          echo "environment-kubeconfig:" ${KUBECONFIG}
          echo "Registry: ${{ github.event.inputs.registry }}"
          echo "Driver image name: ${{ github.event.inputs.driverImageName }}"
          echo "Driver image version: ${{ github.event.inputs.driverImageVersion }}"
          echo "Helm version -"
          helm version
          make e2e-helm-deploy e2e-mock-provider-container e2e-provider-deploy e2e-provider
          # CI=false make e2e-mock-provider-container e2e-provider-deploy